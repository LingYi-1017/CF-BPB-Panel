name: è‡ªåŠ¨æ··æ·†æ„å»º

on:
  push:
    branches: [ main ]
    paths:
      - 'origin.js'
      - 'auto-obfuscate.sh'
  workflow_dispatch:

jobs:
  obfuscate:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: âœ… æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äºŒæ­¥ï¼šé…ç½®Gitç¯å¢ƒ
      - name: ğŸ› ï¸ é…ç½®Gitç¯å¢ƒ
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true

      # ç¬¬ä¸‰æ­¥ï¼šåŒæ­¥æœ€æ–°ä»£ç ï¼ˆå…³é”®ä¿®å¤æ­¥éª¤ï¼‰
      - name: ğŸ”„ åŒæ­¥è¿œç¨‹åˆ†æ”¯
        run: |
          git fetch origin main
          git reset --hard origin/main
          git clean -fd -x  # æ¸…ç†æ‰€æœ‰æœªè·Ÿè¸ªæ–‡ä»¶ï¼ˆåŒ…æ‹¬.gitignoreæ’é™¤çš„ï¼‰

      # ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…æ··æ·†å·¥å…·
        run: npm install -g javascript-obfuscator@4.0.0

      # ç¬¬äº”æ­¥ï¼šç”Ÿæˆæ··æ·†æ–‡ä»¶
      - name: âš™ï¸ æ‰§è¡Œæ··æ·†è„šæœ¬
        run: |
          chmod +x auto-obfuscate.sh
          ./auto-obfuscate.sh || (echo "::error::æ··æ·†è¿‡ç¨‹å¤±è´¥"; exit 1)

      # ç¬¬å…­æ­¥ï¼šæäº¤å‰æœ€ç»ˆåŒæ­¥
      - name: âš¡ æäº¤å‰åŒæ­¥
        run: |
          git add .
          git commit -m "ä¸´æ—¶ä¿å­˜" || echo "æ— æ–°å˜æ›´éœ€è¦ä¿å­˜"
          git pull origin main --rebase

      # ç¬¬ä¸ƒæ­¥ï¼šå¼ºåˆ¶æ¨é€ç»“æœ
      - name: ğŸš€ è‡ªåŠ¨æäº¤å¹¶æ¨é€
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ":lock: è‡ªåŠ¨æ··æ·†æ›´æ–° [$(date +'%m-%d@%H:%M')]"
          file_pattern: |
            _worker.js
            obfuscation-log.txt
          force: true
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
