name: è‡ªåŠ¨æ„å»ºå¹¶æ··æ·†

on:
  push:
    branches: [main]
    paths:
      - "origin.js"
      - "auto-obfuscate.sh"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆå«å®Œæ•´æäº¤å†å²ï¼‰
      - name: âœ… æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. é…ç½®Gitèº«ä»½
      - name: ğŸ› ï¸ é…ç½®Gitç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3. åŒæ­¥æœ€æ–°ä»£ç 
      - name: ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç 
        run: git pull origin main --rebase

      # 4. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…JavaScriptæ··æ·†å™¨
        run: npm install -g javascript-obfuscator@latest

      # 5. æ‰§è¡Œæ··æ·†è„šæœ¬
      - name: ğŸ›¡ï¸ è¿è¡Œè‡ªåŠ¨æ··æ·†
        run: |
          chmod +x auto-obfuscate.sh
          ./auto-obfuscate.sh || (echo "::error::æ··æ·†å¤±è´¥"; exit 1)

      # 6. è°ƒè¯•æ—¥å¿—
      - name: ğŸ“œ æŸ¥çœ‹æ··æ·†æ—¥å¿—
        if: always()
        run: |
          echo "==== æ··æ·†æ—¥å¿— ===="
          cat obfuscation-log.txt
          echo "=================="

      # 7. æäº¤å˜æ›´
      - name: ğŸš€ è‡ªåŠ¨æäº¤ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ":lock: è‡ªåŠ¨æ··æ·†æ›´æ–° [$(date +'%m-%d %H:%M')]"
          file_pattern: |
            _worker.js
            obfuscation-log.txt
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
