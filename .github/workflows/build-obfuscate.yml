name: è‡ªåŠ¨æ··æ·†æ„å»º

on:
  push:
    branches: [ main ]
    paths:
      - 'origin.js'
      - 'auto-obfuscate.sh'
  workflow_dispatch:

jobs:
  obfuscate:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šå®Œæ•´æ£€å‡ºä»£ç ï¼ˆå«å†å²è®°å½•ï¼‰
      - name: ğŸ” æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äºŒæ­¥ï¼šé…ç½®Gitç¯å¢ƒ
      - name: ğŸ› ï¸ é…ç½®Gitç¯å¢ƒ
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true  # å¯ç”¨rebaseæ–¹å¼æ‹‰å–

      # ç¬¬ä¸‰æ­¥ï¼šå¼ºåˆ¶åŒæ­¥è¿œç¨‹åˆ†æ”¯
      - name: ğŸ”„ åŒæ­¥æœ€æ–°ä»£ç 
        run: |
          git fetch origin main:main --force
          git reset --hard origin/main

      # ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…æ··æ·†å·¥å…·
        run: npm install -g javascript-obfuscator@4.0.0

      # ç¬¬äº”æ­¥ï¼šæ‰§è¡Œæ··æ·†è„šæœ¬
      - name: âš™ï¸ ç”Ÿæˆæ··æ·†æ–‡ä»¶
        run: |
          chmod +x auto-obfuscate.sh
          ./auto-obfuscate.sh || (echo "::error::æ··æ·†è¿‡ç¨‹å¤±è´¥"; exit 1)

      # ç¬¬å…­æ­¥ï¼šæœ€ç»ˆåŒæ­¥ï¼ˆé˜²æ­¢å…¶ä»–æäº¤å¯¼è‡´å†²çªï¼‰
      - name: âš¡ æœ€ç»ˆä»£ç åŒæ­¥
        run: |
          git pull origin main --rebase --allow-unrelated-histories

      # ç¬¬ä¸ƒæ­¥ï¼šæäº¤å¹¶å¼ºåˆ¶æ¨é€
      - name: ğŸš€ è‡ªåŠ¨æäº¤ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5  # ä¿®æ­£Actionåç§°
        with:
          branch: main
          commit_message: ":lock: è‡ªåŠ¨æ··æ·†æ›´æ–° [$(date +'%m-%d@%H:%M')]"
          file_pattern: |
            _worker.js
            obfuscation-log.txt
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          force: true  # å…³é”®ä¿®å¤ï¼šå¯ç”¨å¼ºåˆ¶æ¨é€
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
