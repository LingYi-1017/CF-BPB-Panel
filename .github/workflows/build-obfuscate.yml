name: Build Obfuscate BPB Panel

# è§¦å‘æ¡ä»¶ï¼šmain åˆ†æ”¯ pushï¼Œæˆ–æ¯å¤©å®šæ—¶æ„å»º
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 16 * * *" # æ¯å¤© UTC æ—¶é—´ 16:00ï¼ˆåŒ—äº¬æ—¶é—´ 00:00ï¼‰

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»£ç 
      - name: Check out the code
        uses: actions/checkout@v4

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "latest"

      # å®‰è£…æ··æ·†å™¨
      - name: Install dependencies
        run: |
          npm install -g javascript-obfuscator

      # ä¸‹è½½æœ€æ–°æºæ–‡ä»¶ï¼Œå¹¶å¼ºåˆ¶æ›¿æ¢ origin.js
      - name: Download and prepare worker file
        run: |
          if [ -f origin.js ]; then
            echo "âš ï¸ æ£€æµ‹åˆ°æ—§çš„ origin.jsï¼Œæ­£åœ¨åˆ é™¤..."
            rm -f origin.js
          fi

          echo "ğŸŒ æ­£åœ¨ä¸‹è½½æœ€æ–° unobfuscated worker..."
          wget -O origin.zip https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/latest/download/unobfuscated-worker.zip
          unzip origin.zip -d temp
          mv temp/_worker.js ./origin.js
          rm -rf temp origin.zip
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œorigin.js å°±ç»ª"

      # è¿›è¡Œè‡ªåŠ¨æ··æ·†ï¼Œå°è¯•å¤šä¸ªç­–ç•¥ç›´åˆ°æ»¡è¶³ â‰¤1MB é™åˆ¶
      - name: Obfuscate BPB worker js (Auto strategy)
        run: |
          chmod +x ./auto-obfuscate.sh
          ./auto-obfuscate.sh

      # è‡ªåŠ¨æäº¤æ··æ·†åçš„ _worker.js
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ':arrow_up: update obfuscated bpb panel (â‰¤1MB, auto strategy)'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'
