name: è‡ªåŠ¨æ··æ·†æ„å»º

on:
  push:
    branches: [ main ]
    paths:
      - 'origin.js'
      - 'auto-obfuscate.sh'
  workflow_dispatch:

jobs:
  obfuscate:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: âœ… æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ç¬¬äºŒæ­¥ï¼šé…ç½®Gitç¯å¢ƒ
      - name: ğŸ› ï¸ é…ç½®Gitç¯å¢ƒ
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true

      # ç¬¬ä¸‰æ­¥ï¼šåŒæ­¥è¿œç¨‹åˆ†æ”¯ï¼ˆä¿®å¤å…³é”®æ­¥éª¤ï¼‰
      - name: ğŸ”„ å¼ºåˆ¶åŒæ­¥ä»£ç 
        run: |
          git fetch origin main  # ä»…è·å–è¿œç¨‹æ›´æ–°
          git reset --hard origin/main  # é‡ç½®æœ¬åœ°åˆ†æ”¯åˆ°è¿œç¨‹çŠ¶æ€
          git clean -fd  # æ¸…ç†æœªè·Ÿè¸ªæ–‡ä»¶

      # ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…æ··æ·†å·¥å…·
        run: npm install -g javascript-obfuscator@4.0.0

      # ç¬¬äº”æ­¥ï¼šæ‰§è¡Œæ··æ·†è„šæœ¬
      - name: âš™ï¸ ç”Ÿæˆæ··æ·†æ–‡ä»¶
        run: |
          chmod +x auto-obfuscate.sh
          ./auto-obfuscate.sh || (echo "::error::æ··æ·†å¤±è´¥"; exit 1)

      # ç¬¬å…­æ­¥ï¼šæäº¤å‰åŒæ­¥
      - name: âš¡ æœ€ç»ˆåŒæ­¥
        run: |
          git pull origin main --rebase

      # ç¬¬ä¸ƒæ­¥ï¼šè‡ªåŠ¨æäº¤
      - name: ğŸš€ æ¨é€å˜æ›´
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ":lock: è‡ªåŠ¨æ··æ·†æ›´æ–° [$(date +'%m-%d@%H:%M')]"
          file_pattern: |
            _worker.js
            obfuscation-log.txt
          force: true
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
