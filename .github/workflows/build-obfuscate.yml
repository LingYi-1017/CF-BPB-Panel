name: 自动构建并混淆

on:
  push:
    branches: [main]
    paths:
      - "origin.js"
      - "auto-obfuscate.sh"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码（含完整提交历史）
      - name: ✅ 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. 配置Git身份
      - name: 🛠️ 配置Git用户
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3. 同步最新代码
      - name: 🔄 拉取最新代码
        run: git pull origin main --rebase

      # 4. 安装依赖
      - name: 📦 安装JavaScript混淆器
        run: npm install -g javascript-obfuscator@latest

      # 5. 执行混淆脚本
      - name: 🛡️ 运行自动混淆
        run: |
          chmod +x auto-obfuscate.sh
          ./auto-obfuscate.sh || (echo "::error::混淆失败"; exit 1)

      # 6. 调试日志
      - name: 📜 查看混淆日志
        if: always()
        run: |
          echo "==== 混淆日志 ===="
          cat obfuscation-log.txt
          echo "=================="

      # 7. 提交变更
      - name: 🚀 自动提交结果
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ":lock: 自动混淆更新 [$(date +'%m-%d %H:%M')]"
          file_pattern: |
            _worker.js
            obfuscation-log.txt
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
